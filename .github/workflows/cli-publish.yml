name: Publish CLI

on:
  release:
    types: [published]

jobs:
  publish-npm:
    name: Publish to npm
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Set version from tag
        working-directory: cli
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF#refs/tags/v}"
          npm version "$VERSION" --no-git-tag-version

      - name: Install dependencies
        working-directory: cli
        run: bun install --frozen-lockfile

      - name: Publish
        working-directory: cli
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
          npm publish
          rm .npmrc

  update-homebrew-tap:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF#refs/tags/}"
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/refs/tags/${TAG}.tar.gz"
          curl -fsSL -o /tmp/source.tar.gz "$TARBALL_URL"
          SHA=$(sha256sum /tmp/source.tar.gz | awk '{print $1}')
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA}" >> "$GITHUB_OUTPUT"

      - name: Update formula
        run: |
          set -euo pipefail
          sed -e "s|__TAG__|${{ steps.release.outputs.tag }}|g" \
              -e "s|__SHA256__|${{ steps.release.outputs.sha256 }}|g" \
              cli/Formula/superserve.rb > /tmp/superserve.rb

      - name: Push to tap repo
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git clone "https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/superserve-ai/homebrew-tap.git" tap
          mkdir -p tap/Formula
          cp /tmp/superserve.rb tap/Formula/superserve.rb
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/superserve.rb
          git diff --staged --quiet && echo "Formula unchanged, skipping." && exit 0
          git commit -m "superserve ${{ steps.release.outputs.tag }}"
          git push
